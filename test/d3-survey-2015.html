<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://cdn.jsdelivr.net/npm/d3@6"></script>
<script src="../dist/@observablehq/plot.umd.js"></script>
<script>

d3.json("data/d3-survey-2015.json").then(responses => {
  document.body.append(
    chooseOne(responses, "comfort", "How comfortable are you with d3 now?"),
    chooseMany(responses, "why", "Why do you want to learn d3?"),
    chooseMany(responses, "tech", "Have you used any of the following technologies?"),
    chooseMany(responses, "projects", "What kind of projects do you want to use d3 for?"),
    chooseOne(responses, "forloops", "Are you comfortable with for loops?"),
    chooseOne(responses, "trig", "Do you remember trigonometry?"),
    chooseOne(responses, "gestalt", "Does the word gestalt mean anything to you?"),
    chooseOne(responses, "tools", "What is your favorite tool for data visualization so far?"),
    chooseMany(responses, "libraries", "Have you used any of the following libraries?"),
    chooseOne(responses,  "feature", "Which feature of d3 get you most excited?"),
    chooseMany(responses, "format", "Which formats would you be interested in paying for to learn d3?"),
    chooseOne(responses, "city", "What city are you in?"),
  );
});

// TODO consolidate bars into Other category
function chooseOne(responses, y, title) {
  return bars(
    responses,
    d3.groups(responses, d => d[y]),
    title
  );
}

function chooseMany(responses, y, title) {
  return bars(
    responses,
    Array.from(
      new Set(responses.flatMap(d => d[y])),
      v => [v, responses.filter(d => d[y].includes(v))]
    ),
    title
  );
}

function bars(responses, groups, title) {
  return Plot.plot({
    marginLeft: 300,
    width: 960,
    height: groups.length * 20 + 50,
    x: {
      grid: true,
      axis: "top",
      domain: [0, 100],
      label: "Frequency (%) â†’"
    },
    y: {
      padding: 0,
      label: title,
      labelAnchor: "top",
      domain: groups.map(([key, group]) => [key, group.length])
        .sort(([ak, av], [bk, bv]) => d3.descending(av, bv) || d3.ascending(ak, bk))
        .map(([key]) => key)
    },
    marks: [
      Plot.barX(groups, {
        x: ([, group]) => group.length / responses.length * 100,
        y: ([key]) => key,
        fill: "steelblue",
        insetTop: 1
      }),
      Plot.ruleX([0])
    ]
  });
}

</script>
