<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="https://cdn.jsdelivr.net/npm/d3@6"></script>
<script src="../dist/@observablehq/plot.umd.js"></script>
<script>

d3.csv("data/aapl.csv", d3.autoType).then(AAPL => {
  document.body.appendChild(Plot.plot({
    axes: {
      y: {grid: true}
    },
    marks: [
      new Plot.RuleY([0]),
      new Plot.AreaY(AAPL, {x: "Date", y: "Close", fillOpacity: 0.1}),
      new Plot.LineY(AAPL, {x: "Date", y: "Close"})
    ]
  }));
});

d3.csv("data/sf-temperatures.csv", d3.autoType).then(temperatures => {
  document.body.appendChild(Plot.plot({
    axes: {
      x: {label: null}, // TODO Default to null for temporal scales?
      y: {grid: true, label: "↑ Daily temperature range (°F)"}
    },
    marks: [
      new Plot.AreaY(temperatures, {curve: "step", x: "date", y1: "low", y2: "high", fill: "#ccc"}),
      new Plot.LineY(temperatures, {curve: "step", x: "date", y: movingAverage(temperatures, 7, d => d.low), stroke: "blue"}),
      new Plot.LineY(temperatures, {curve: "step", x: "date", y: movingAverage(temperatures, 7, d => d.high), stroke: "red"})
    ],
    width: 960
  }));
});

// TODO Move to d3-array?
function movingAverage(values, N, value) {
  let i = 0;
  let sum = 0;
  values = Float64Array.from(values, value);
  const means = new Float64Array(values.length);
  for (let n = Math.min(N - 1, values.length); i < n; ++i) {
    means[i] = NaN;
    sum += values[i];
  }
  for (let n = values.length; i < n; ++i) {
    sum += values[i];
    means[i] = sum / N;
    sum -= values[i - N + 1];
  }
  means.subarray(0, N >> 1).reverse();
  means.subarray(N >> 1).reverse();
  means.reverse();
  return means;
}

</script>
